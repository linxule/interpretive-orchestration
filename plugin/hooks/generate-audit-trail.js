#!/usr/bin/env node

/**
 * PostSynthesis Hook: Audit Trail Generation
 *
 * After synthesis work, automatically generates confirmability documentation.
 * Creates transparent record of all analytical decisions with rationales.
 *
 * Philosophy: Confirmability through transparent documentation
 * Purpose: Every analytical decision traced and justified
 */

const fs = require('fs');
const path = require('path');

function findProjectRoot(startPath) {
  let currentPath = startPath;
  while (currentPath !== path.parse(currentPath).root) {
    if (fs.existsSync(path.join(currentPath, '.interpretive-orchestration'))) {
      return currentPath;
    }
    currentPath = path.dirname(currentPath);
  }
  return null;
}

// Output structured remediation JSON (machine-readable)
function outputRemediation(code, severity, reason, nextCommands, nextSkills, canBypass, details) {
  const remediation = {
    code,
    severity,
    reason,
    next_commands: nextCommands,
    next_skills: nextSkills,
    can_bypass: canBypass,
    details
  };

  // Output JSON to stderr for machine parsing
  console.error(JSON.stringify(remediation));
}

function parseJsonlSafely(content) {
  const lines = content.split('\n').filter(line => line.trim());
  const parsed = [];
  const errors = [];

  for (let i = 0; i < lines.length; i++) {
    try {
      parsed.push(JSON.parse(lines[i]));
    } catch (error) {
      errors.push({ line: i + 1, preview: lines[i].substring(0, 50) + '...' });
    }
  }

  return { logs: parsed, malformedCount: errors.length, errors };
}

function generateAuditTrail(projectRoot) {
  const configPath = path.join(projectRoot, '.interpretive-orchestration', 'config.json');
  const logPath = path.join(projectRoot, '.interpretive-orchestration', 'conversation-log.jsonl');

  if (!fs.existsSync(configPath) || !fs.existsSync(logPath)) {
    return { success: false, error: 'Config or log file not found' };
  }

  let config;
  try {
    config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
  } catch (error) {
    return { success: false, error: `Failed to parse config: ${error.message}` };
  }

  const logContent = fs.readFileSync(logPath, 'utf8');
  const { logs, malformedCount, errors: parseErrors } = parseJsonlSafely(logContent);

  // Generate audit trail markdown
  const auditTrail = `# Audit Trail: Synthesis Activities

**Generated:** ${new Date().toISOString()}
**Project:** ${config.project_info?.name || 'Qualitative Research Project'}
**Philosophical Stance:** ${config.philosophical_stance?.tradition || 'Not specified'}

---

## Purpose

This audit trail documents all synthesis activities for confirmability and transparency.
Every analytical decision is traced to specific actions with rationales.

---

## Synthesis Activities

${logs.filter(log => log.activity_type === 'synthesis' || log.stage?.includes('synthesis'))
  .map((log, index) => `
### Activity ${index + 1}: ${log.message}

**Timestamp:** ${log.timestamp}
**From:** ${log.from}
**Stage:** ${log.stage}

${log.metadata ? `**Details:**
${Object.entries(log.metadata).map(([key, value]) => `- ${key}: ${JSON.stringify(value)}`).join('\n')}
` : ''}

${log.philosophy_check ? `**Philosophy Check:** ${log.philosophy_check}` : ''}

---
`).join('\n')}

## Human Decisions

${logs.filter(log => log.from === 'human_researcher' && log.activity_type !== 'reflexive_insight')
  .map((log, index) => `
### Decision ${index + 1}: ${log.message}

**Timestamp:** ${log.timestamp}
**Context:** ${log.stage}

${log.metadata?.rationale ? `**Rationale:** ${log.metadata.rationale}` : ''}

---
`).join('\n')}

## Epistemic Tool Usage

${logs.filter(log => log.activity_type === 'deep_reasoning' || log.activity_type === 'paradox_navigation')
  .map((log, index) => `
### Tool Use ${index + 1}: ${log.from}

**Purpose:** ${log.message}
**Timestamp:** ${log.timestamp}

${log.epistemic_value ? `**Value:** ${log.epistemic_value}` : ''}

---
`).join('\n')}

## Reflexive Insights

${logs.filter(log => log.activity_type === 'reflexive_insight')
  .map((log, index) => `
### Insight ${index + 1}

**Timestamp:** ${log.timestamp}
**Insight:** ${log.message}

${log.follow_up ? `**Follow-up:** ${log.follow_up}` : ''}

---
`).join('\n')}

## Confirmability Statement

This audit trail provides:
- Complete chronology of analytical activities
- Transparent record of human decisions
- Documentation of AI assistance (what, when, how)
- Philosophical coherence verification
- Epistemic tool usage tracking
- Reflexive awareness throughout

**All claims traceable from raw data through this documented process to theoretical conclusions.**

---

**Generated by:** Interpretive Orchestration - Epistemic Partnership System
**Methodology:** Human-AI-Human Sandwich with enforced reflexivity
${malformedCount > 0 ? `

---

**Note:** ${malformedCount} log entries could not be parsed and were skipped.
` : ''}
`;

  return {
    success: true,
    auditTrail,
    stats: {
      totalLogs: logs.length,
      malformedCount,
      parseErrors: parseErrors.length > 0 ? parseErrors.slice(0, 5) : null  // Show first 5 errors max
    }
  };
}

function main() {
  const projectRoot = findProjectRoot(process.cwd());

  if (!projectRoot) {
    process.exit(0);
  }

  console.log('');
  console.log('ðŸ“Š Generating Audit Trail...');
  console.log('');

  const result = generateAuditTrail(projectRoot);

  if (!result.success) {
    console.error(`   âœ— Failed to generate audit trail: ${result.error}`);
    process.exit(1);
  }

  const outputPath = path.join(projectRoot, 'outputs', 'audit-trail.md');

  // Ensure outputs directory exists
  const outputDir = path.dirname(outputPath);
  if (!fs.existsSync(outputDir)) {
    fs.mkdirSync(outputDir, { recursive: true });
  }

  fs.writeFileSync(outputPath, result.auditTrail);

  // Output structured remediation for machine parsing
  outputRemediation(
    'AUDIT_TRAIL_GENERATED',
    'info',  // This is informational, not a warning or blocker
    'Audit trail generated for confirmability and transparency',
    ['/qual-status', '/qual-reflect'],
    ['project-dashboard'],
    true,  // Always bypassable - it's informational
    {
      output_file: 'outputs/audit-trail.md',
      logs_processed: result.stats.totalLogs,
      logs_skipped: result.stats.malformedCount,
      includes: [
        'Complete chronology of analytical activities',
        'Human decisions with rationales',
        'AI assistance documentation',
        'Epistemic tool usage',
        'Reflexive insights'
      ],
      use_for: ['Manuscript methods section', 'Confirmability demonstration', 'Transparent research documentation']
    }
  );

  console.log('   âœ“ Audit trail generated: outputs/audit-trail.md');
  console.log('');

  // Report any parsing issues
  if (result.stats.malformedCount > 0) {
    console.log(`   âš ï¸  Warning: ${result.stats.malformedCount} log entries could not be parsed (skipped)`);
    if (result.stats.parseErrors) {
      console.log('   First few errors:');
      result.stats.parseErrors.forEach(err => {
        console.log(`      Line ${err.line}: ${err.preview}`);
      });
    }
    console.log('');
  }

  console.log('   ðŸ“‹ Includes:');
  console.log(`   â€¢ ${result.stats.totalLogs} log entries processed`);
  console.log('   â€¢ Complete chronology of analytical activities');
  console.log('   â€¢ All human decisions with rationales');
  console.log('   â€¢ AI assistance documentation');
  console.log('   â€¢ Epistemic tool usage');
  console.log('   â€¢ Reflexive insights');
  console.log('');
  console.log('   ðŸŽ¯ Use for:');
  console.log('   â€¢ Manuscript methods section');
  console.log('   â€¢ Confirmability demonstration');
  console.log('   â€¢ Transparent research documentation');
  console.log('');

  // Log the audit trail generation
  const logPath = path.join(projectRoot, '.interpretive-orchestration', 'conversation-log.jsonl');
  const logEntry = {
    timestamp: new Date().toISOString(),
    from: 'post_synthesis_hook',
    to: 'human_researcher',
    message: 'Audit trail generated automatically after synthesis. Complete documentation of analytical process created for confirmability.',
    stage: 'stage2_synthesis_complete',
    activity_type: 'audit_trail_generation',
    metadata: {
      output_file: 'outputs/audit-trail.md',
      purpose: 'confirmability_and_transparency',
      logs_processed: result.stats.totalLogs,
      logs_skipped: result.stats.malformedCount
    },
    philosophy_check: 'Transparent documentation enables confirmability'
  };

  fs.appendFileSync(logPath, JSON.stringify(logEntry) + '\n');

  process.exit(0);
}

try {
  main();
} catch (error) {
  // Report error instead of silently failing
  console.error(`   âœ— Audit trail generation failed: ${error.message}`);
  process.exit(1);
}
